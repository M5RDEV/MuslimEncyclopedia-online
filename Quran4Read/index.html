<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>منصة قراءة القرآن الكريم</title>
  <style>
    :root {
      --primary-color: #2e7d32;
      --secondary-color: #e8f5e9;
      --accent-color: #1b5e20;
      --light-bg: #f9f9f9;
      --dark-text: #333;
      --light-text: #fff;
      --border-color: #ddd;
      --overlay-color: rgba(0, 0, 0, 0.7);
      --box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', 'Amiri', sans-serif;
    }

    body {
      background-color: var(--light-bg);
      color: var(--dark-text);
      transition: var(--transition);
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      height: 100vh;
      background-color: var(--light-bg);
      border-left: 1px solid var(--border-color);
      position: fixed;
      right: 0;
      top: 0;
      transition: var(--transition);
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--box-shadow);
    }

    .sidebar-header {
      background-color: var(--primary-color);
      color: var(--light-text);
      padding: 20px;
      text-align: center;
    }

    .sidebar-header h2 {
      margin-bottom: 10px;
    }

    .sidebar-nav {
      padding: 15px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-nav ul {
      list-style: none;
      display: flex;
      justify-content: space-around;
    }

    .sidebar-nav li {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 20px;
      transition: var(--transition);
    }

    .sidebar-nav li.active {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      font-weight: bold;
    }

    .sidebar-nav li:hover:not(.active) {
      background-color: var(--secondary-color);
      opacity: 0.7;
    }

    .sidebar-content {
      padding: 15px;
    }

    .search-bar {
      background-color: var(--secondary-color);
      border-radius: 20px;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .search-bar input {
      flex: 1;
      border: none;
      background-color: transparent;
      outline: none;
      color: var(--dark-text);
      text-align: right;
    }

    .search-bar i {
      color: var(--primary-color);
    }

    .surah-list {
      list-style: none;
    }

    .surah-item {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .surah-item:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
    }

    .surah-item.active {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .surah-number {
      background-color: var(--accent-color);
      color: var(--light-text);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 12px;
    }

    .surah-item.active .surah-number {
      background-color: var(--light-bg);
      color: var(--primary-color);
    }

    .surah-info {
      flex: 1;
      text-align: right;
    }

    .surah-name-en {
      font-size: 14px;
    }

    .surah-name-ar {
      font-size: 18px;
      margin-top: 2px;
      font-family: 'Amiri', serif;
    }

    .surah-meta {
      font-size: 12px;
      color: #666;
    }

    .surah-item.active .surah-meta {
      color: var(--secondary-color);
    }

    .main-content {
      flex: 1;
      margin-right: 280px;
      transition: var(--transition);
    }

    .top-bar {
      background-color: var(--light-bg);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 90;
      box-shadow: var(--box-shadow);
    }

    .current-surah {
      font-size: 20px;
      font-weight: 500;
    }

    .top-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      background-color: transparent;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      color: var(--dark-text);
    }

    .btn:hover {
      background-color: var(--secondary-color);
      color: var(--primary-color);
    }

    .btn.primary {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .btn.primary:hover {
      background-color: var(--accent-color);
    }

    .settings-panel {
      position: fixed;
      top: 0;
      left: -350px;
      width: 350px;
      height: 100vh;
      background-color: var(--light-bg);
      box-shadow: var(--box-shadow);
      z-index: 100;
      transition: var(--transition);
      padding: 20px;
      overflow-y: auto;
    }

    .settings-panel.active {
      left: 0;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: var(--transition);
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--primary-color);
    }

    input:checked+.slider:before {
      transform: translateX(24px);
    }

    select,
    .range-container {
      background-color: var(--secondary-color);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--dark-text);
      outline: none;
      width: 180px;
      text-align: right;
    }

    .range-container {
      padding: 0;
    }

    input[type="range"] {
      width: 100%;
      height: 34px;
      background-color: transparent;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      margin-top: -6px;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: #ddd;
      border-radius: 3px;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--overlay-color);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
      z-index: 95;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .quran-content {
      padding: 20px 30px 100px;
    }

    .surah-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .bismillah {
      font-size: 28px;
      margin: 20px 0;
      text-align: center;
      color: var(--accent-color);
      font-family: 'Amiri', serif;
    }

    .verse-container {
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }

    .verse-container:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    .verse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .verse-number {
      background-color: var(--primary-color);
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .verse-actions {
      display: flex;
      gap: 10px;
    }

    .verse-arabic {
      font-size: 28px;
      line-height: 2;
      margin-bottom: 20px;
      text-align: right;
      font-family: 'Amiri', serif;
    }

    .verse-translation {
      margin-bottom: 15px;
      line-height: 1.6;
      text-align: right;
    }

    .verse-tafsir {
      background-color: var(--secondary-color);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-right: 4px solid var(--primary-color);
      text-align: right;
    }

    .tafsir-title {
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .surah-actions {
      position: fixed;
      bottom: 0;
      right: 280px;
      left: 0;
      background-color: var(--light-bg);
      padding: 15px 30px;
      box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
      z-index: 80;
    }

    .action-btn {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-weight: 500;
    }

    .action-btn:hover {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .action-btn.play {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .action-btn.play:hover {
      background-color: var(--accent-color);
    }

    .action-group {
      display: flex;
      gap: 10px;
    }

    .audio-player {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
      max-width: 500px;
      margin: 0 auto;
    }

    .audio-progress {
      flex: 1;
      height: 6px;
      background-color: var(--border-color);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }

    .progress-bar {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 3px;
      width: 30%;
    }

    .time {
      font-size: 12px;
      color: #666;
    }

    /* Dark mode styles */
    body.dark-mode {
      background-color: #1a1a1a;
      color: #ddd;
    }

    body.dark-mode .sidebar,
    body.dark-mode .top-bar,
    body.dark-mode .settings-panel {
      background-color: #222;
      border-color: #333;
    }

    body.dark-mode .btn {
      color: #ddd;
    }

    body.dark-mode .btn:hover {
      background-color: #333;
      color: var(--primary-color);
    }

    body.dark-mode .verse-container {
      background-color: #2a2a2a;
    }

    body.dark-mode .search-bar,
    body.dark-mode select,
    body.dark-mode .range-container,
    body.dark-mode .verse-tafsir {
      background-color: #333;
      color: #ddd;
    }

    body.dark-mode .surah-actions {
      background-color: #222;
    }

    body.dark-mode .surah-item:hover {
      background-color: #333;
    }

    body.dark-mode input[type="range"]::-webkit-slider-runnable-track {
      background: #444;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Responsive styles */
    .mobile-toggle {
      display: none;
      font-size: 24px;
      cursor: pointer;
    }

    @media (max-width: 992px) {
      .sidebar {
        right: -280px;
      }

      .sidebar.active {
        right: 0;
      }

      .main-content {
        margin-right: 0;
      }

      .surah-actions {
        right: 0;
      }

      .mobile-toggle {
        display: block;
      }

      .audio-player {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      .settings-panel {
        width: 300px;
      }

      .action-group {
        display: none;
      }

      .action-group.mobile {
        display: flex;
        margin-top: 15px;
        justify-content: center;
      }

      .surah-actions {
        flex-direction: column;
        padding: 15px;
      }

      .audio-player {
        width: 100%;
      }
    }

    @media (max-width: 576px) {
      .quran-content {
        padding: 15px 15px 160px;
      }

      .verse-arabic {
        font-size: 22px;
      }

      .top-bar {
        padding: 15px;
      }

      .current-surah {
        font-size: 16px;
      }
    }
  </style>
  <!-- Font imports -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Amiri:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>المصحف الالكتروني</h2>
      <p>اقرأ، استمع، تدبر</p>
    </div>
    <div class="sidebar-nav">
      <ul>
        <li class="active" data-tab="surahs">السور</li>
        <li data-tab="juz">الأجزاء</li>
        <li data-tab="hizb">الأحزاب</li>
      </ul>
    </div>
    <div class="sidebar-content">
      <div class="search-bar">
        <input type="text" placeholder="ابحث عن سورة..." id="searchInput">
        <i class="fas fa-search"></i>
      </div>
      <div class="tab-content" id="surahsTab">
        <ul class="surah-list" id="surahList">
          <div class="loading-spinner" style="display: block; margin: 20px auto;"></div>
        </ul>
      </div>
      <div class="tab-content" id="juzTab" style="display: none;">
        <div class="loading-spinner" style="display: block; margin: 20px auto;"></div>
      </div>
      <div class="tab-content" id="hizbTab" style="display: none;">
        <div class="loading-spinner" style="display: block; margin: 20px auto;"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="mobile-toggle">
        <i class="fas fa-bars"></i>
      </div>
      <div class="current-surah" id="currentSurahTitle">جاري التحميل...</div>
      <div class="top-actions">
        <button class="btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
      </div>
    </div>

    <div class="quran-content" id="quranContent">
      <div class="loading-spinner" style="display: block; margin: 50px auto;"></div>
    </div>

    <div class="surah-actions">
      <div class="audio-player">
        <button class="btn play" id="playBtn"><i class="fas fa-play"></i></button>
        <div class="audio-progress" id="progressBar">
          <div class="progress-bar" id="progressFill"></div>
        </div>
        <div class="time" id="timeDisplay">0:00 / 0:00</div>
      </div>
      <div class="action-group">
        <button class="action-btn" id="copySurahBtn"><i class="fas fa-copy"></i> نسخ السورة</button>
        <button class="action-btn" id="downloadSurahBtn"><i class="fas fa-download"></i> تحميل</button>
      </div>
      <div class="action-group mobile" style="display: none;">
        <button class="action-btn" id="copySurahBtnMobile"><i class="fas fa-copy"></i> نسخ</button>
        <button class="action-btn" id="downloadSurahBtnMobile"><i class="fas fa-download"></i> تحميل</button>
      </div>
    </div>
  </div>

  <!-- Settings Panel -->
  <div class="settings-panel">
    <div class="settings-header">
      <h2>الإعدادات</h2>
      <button class="btn" id="closeSettings"><i class="fas fa-times"></i></button>
    </div>

    <div class="settings-section">
      <h3>العرض</h3>
      <div class="setting-item">
        <span>الوضع الليلي</span>
        <label class="toggle">
          <input type="checkbox" id="darkModeToggle">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <span>حجم الخط</span>
        <div class="range-container">
          <input type="range" min="1" max="10" value="5" id="fontSizeSlider">
        </div>
      </div>
    </div>

    <div class="settings-section">
      <h3>الترجمة</h3>
      <div class="setting-item">
        <span>إظهار الترجمة</span>
        <label class="toggle">
          <input type="checkbox" checked id="showTranslationToggle">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <span>مصدر الترجمة</span>
        <select id="translationSelect">
          <option value="ar.muyassar">التفسير الميسر</option>
          <option value="en.sahih">Sahih International (English)</option>
          <option value="ur.maududi">مولانا مودودی (أردو)</option>
        </select>
      </div>
    </div>

    <div class="settings-section">
      <h3>التفسير</h3>
      <div class="setting-item">
        <span>إظهار التفسير</span>
        <label class="toggle">
          <input type="checkbox" checked id="showTafsirToggle">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <span>مصدر التفسير</span>
        <select id="tafsirSelect">
          <option value="ar.ibn-kathir">ابن كثير</option>
          <option value="ar.jalalayn">الجلالين</option>
          <option value="ar.qurtubi">القرطبي</option>
        </select>
      </div>
    </div>

    <div class="settings-section">
      <h3>التلاوة</h3>
      <div class="setting-item">
        <span>القارئ</span>
        <select id="reciterSelect">
          <option value="ar.alafasy">مشاري العفاسي</option>
          <option value="ar.abdulsamad">عبد الباسط عبد الصمد</option>
          <option value="ar.abdurrahmaansudais">عبد الرحمن السديس</option>
          <option value="ar.husary">محمود خليل الحصري</option>
        </select>
      </div>
      <div class="setting-item">
        <span>التشغيل التلقائي</span>
        <label class="toggle">
          <input type="checkbox" id="autoPlayToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Overlay for mobile -->
  <div class="overlay"></div>

  <script>
    // API endpoints
    const API_BASE = 'https://api.alquran.cloud/v1';
    const EDITION_API = 'https://api.alquran.cloud/v1/edition';

    // Global variables
    let currentSurah = 1;
    let currentAyah = 1;
    let audioPlayer = new Audio();
    let isPlaying = false;
    let surahsData = [];
    let currentSurahData = null;
    let settings = {
      darkMode: localStorage.getItem('darkMode') === 'true',
      fontSize: localStorage.getItem('fontSize') || '5',
      showTranslation: localStorage.getItem('showTranslation') !== 'false',
      showTafsir: localStorage.getItem('showTafsir') !== 'false',
      translation: localStorage.getItem('translation') || 'ar.muyassar',
      tafsir: localStorage.getItem('tafsir') || 'ar.ibn-kathir',
      reciter: localStorage.getItem('reciter') || 'ar.alafasy',
      autoPlay: localStorage.getItem('autoPlay') === 'true'
    };

    // DOM elements
    const elements = {
      surahList: document.getElementById('surahList'),
      quranContent: document.getElementById('quranContent'),
      currentSurahTitle: document.getElementById('currentSurahTitle'),
      searchInput: document.getElementById('searchInput'),
      playBtn: document.getElementById('playBtn'),
      progressBar: document.getElementById('progressBar'),
      progressFill: document.getElementById('progressFill'),
      timeDisplay: document.getElementById('timeDisplay'),
      darkModeToggle: document.getElementById('darkModeToggle'),
      fontSizeSlider: document.getElementById('fontSizeSlider'),
      showTranslationToggle: document.getElementById('showTranslationToggle'),
      showTafsirToggle: document.getElementById('showTafsirToggle'),
      translationSelect: document.getElementById('translationSelect'),
      tafsirSelect: document.getElementById('tafsirSelect'),
      reciterSelect: document.getElementById('reciterSelect'),
      autoPlayToggle: document.getElementById('autoPlayToggle'),
      copySurahBtn: document.getElementById('copySurahBtn'),
      downloadSurahBtn: document.getElementById('downloadSurahBtn'),
      copySurahBtnMobile: document.getElementById('copySurahBtnMobile'),
      downloadSurahBtnMobile: document.getElementById('downloadSurahBtnMobile'),
      surahsTab: document.getElementById('surahsTab'),
      juzTab: document.getElementById('juzTab'),
      hizbTab: document.getElementById('hizbTab')
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadSurahs();
      applySettings();
      setupEventListeners();
    });

    // Setup event listeners
    function setupEventListeners() {
      // Toggle sidebar on mobile
      document.querySelector('.mobile-toggle').addEventListener('click', toggleSidebar);

      // Toggle settings panel
      document.getElementById('settingsBtn').addEventListener('click', toggleSettingsPanel);
      document.getElementById('closeSettings').addEventListener('click', toggleSettingsPanel);

      // Close sidebar and settings when overlay is clicked
      document.querySelector('.overlay').addEventListener('click', () => {
        document.querySelector('.sidebar').classList.remove('active');
        document.querySelector('.settings-panel').classList.remove('active');
        document.querySelector('.overlay').classList.remove('active');
      });

      // Sidebar navigation tabs
      document.querySelectorAll('.sidebar-nav li').forEach(item => {
        item.addEventListener('click', function () {
          document.querySelectorAll('.sidebar-nav li').forEach(i => i.classList.remove('active'));
          this.classList.add('active');

          // Hide all tab contents
          document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
          });

          // Show selected tab content
          const tabId = this.dataset.tab + 'Tab';
          document.getElementById(tabId).style.display = 'block';
        });
      });

      // Search functionality
      elements.searchInput.addEventListener('input', searchSurahs);

      // Audio player controls
      elements.playBtn.addEventListener('click', togglePlay);
      elements.progressBar.addEventListener('click', seekAudio);

      // Settings changes
      elements.darkModeToggle.addEventListener('change', toggleDarkMode);
      elements.fontSizeSlider.addEventListener('input', updateFontSize);
      elements.showTranslationToggle.addEventListener('change', toggleTranslation);
      elements.showTafsirToggle.addEventListener('change', toggleTafsir);
      elements.translationSelect.addEventListener('change', updateTranslation);
      elements.tafsirSelect.addEventListener('change', updateTafsir);
      elements.reciterSelect.addEventListener('change', updateReciter);
      elements.autoPlayToggle.addEventListener('change', updateAutoPlay);

      // Copy and download buttons
      elements.copySurahBtn.addEventListener('click', copyCurrentSurah);
      elements.downloadSurahBtn.addEventListener('click', downloadCurrentSurah);
      elements.copySurahBtnMobile.addEventListener('click', copyCurrentSurah);
      elements.downloadSurahBtnMobile.addEventListener('click', downloadCurrentSurah);

      // Audio player events
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('ended', playNextAyah);
      audioPlayer.addEventListener('play', () => {
        isPlaying = true;
        elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
      });
      audioPlayer.addEventListener('pause', () => {
        isPlaying = false;
        elements.playBtn.innerHTML = '<i class="fas fa-play"></i>';
      });
    }

    // Load list of surahs from API
    async function loadSurahs() {
      try {
        elements.surahList.innerHTML = '<div class="loading-spinner" style="display: block; margin: 20px auto;"></div>';

        const response = await fetch(`${API_BASE}/surah`);
        const data = await response.json();

        if (data.code === 200 && data.status === "OK") {
          surahsData = data.data;
          renderSurahsList(data.data);
          loadSurah(currentSurah);
        } else {
          throw new Error('Failed to load surahs');
        }
      } catch (error) {
        console.error('Error loading surahs:', error);
        elements.surahList.innerHTML = '<div class="error">حدث خطأ أثناء تحميل السور. يرجى المحاولة لاحقاً.</div>';
      }
    }

    // Render surahs list
    function renderSurahsList(surahs) {
      elements.surahList.innerHTML = '';

      surahs.forEach(surah => {
        const li = document.createElement('li');
        li.className = 'surah-item';
        li.dataset.number = surah.number;

        li.innerHTML = `
          <div class="surah-number">${surah.number}</div>
          <div class="surah-info">
            <div class="surah-name-en">${surah.englishName}</div>
            <div class="surah-name-ar">${surah.name}</div>
            <div class="surah-meta">${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'} • ${surah.numberOfAyahs} آيات</div>
          </div>
        `;

        li.addEventListener('click', () => {
          document.querySelectorAll('.surah-item').forEach(item => {
            item.classList.remove('active');
          });
          li.classList.add('active');
          currentSurah = surah.number;
          loadSurah(surah.number);

          // Close sidebar on mobile
          if (window.innerWidth <= 992) {
            toggleSidebar();
          }
        });

        if (surah.number === currentSurah) {
          li.classList.add('active');
        }

        elements.surahList.appendChild(li);
      });
    }

    // Load a surah by number
    async function loadSurah(surahNumber) {
      try {
        elements.quranContent.innerHTML = '<div class="loading-spinner" style="display: block; margin: 50px auto;"></div>';

        // Load surah info
        const surahResponse = await fetch(`${API_BASE}/surah/${surahNumber}/ar.alafasy`);
        const surahData = await surahResponse.json();

        if (surahData.code !== 200 || surahData.status !== "OK") {
          throw new Error('Failed to load surah');
        }

        currentSurahData = surahData.data;
        elements.currentSurahTitle.textContent = `${currentSurahData.englishName} (${currentSurahData.name})`;

        // Load translation
        let translation = { ayahs: [] };
        try {
          const translationResponse = await fetch(`${API_BASE}/surah/${surahNumber}/${settings.translation}`);
          const translationData = await translationResponse.json();
          if (translationData.code === 200 && translationData.status === "OK") {
            translation = translationData.data;
          }
        } catch (error) {
          console.error('Error loading translation:', error);
        }

        // Load tafsir
        let tafsir = { ayahs: [] };
        try {
          const tafsirResponse = await fetch(`${API_BASE}/surah/${surahNumber}/${settings.tafsir}`);
          const tafsirData = await tafsirResponse.json();
          if (tafsirData.code === 200 && tafsirData.status === "OK") {
            tafsir = tafsirData.data;
          }
        } catch (error) {
          console.error('Error loading tafsir:', error);
        }

        // Render surah content
        renderSurahContent(currentSurahData, translation, tafsir);

      } catch (error) {
        console.error('Error loading surah:', error);
        elements.quranContent.innerHTML = '<div class="error">حدث خطأ أثناء تحميل السورة. يرجى المحاولة لاحقاً.</div>';
      }
    }

    // Render surah content
    function renderSurahContent(surah, translation, tafsir) {
      let html = `
        <div class="surah-header">
          <h1>سورة ${surah.englishName} - ${surah.name}</h1>
          <p>${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'} • ${surah.numberOfAyahs} آيات</p>
        </div>
      `;

      if (surah.number !== 1 && surah.number !== 9) {
        html += `<div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>`;
      }

      surah.ayahs.forEach((ayah, index) => {
        const ayahTranslation = translation?.ayahs?.[index]?.text || '';
        const ayahTafsir = tafsir?.ayahs?.[index]?.text || '';

        html += `
          <div class="verse-container" data-number="${ayah.numberInSurah}">
            <div class="verse-header">
              <div class="verse-number">${ayah.numberInSurah}</div>
              <div class="verse-actions">
                <button class="btn" onclick="copyAyah(${surah.number}, ${ayah.numberInSurah})"><i class="fas fa-copy"></i></button>
                <button class="btn" onclick="playAyah(${surah.number}, ${ayah.numberInSurah})"><i class="fas fa-play"></i></button>
              </div>
            </div>
            <div class="verse-arabic">${ayah.text}</div>
            ${settings.showTranslation ? `<div class="verse-translation">${ayahTranslation}</div>` : ''}
            ${settings.showTafsir && ayahTafsir ? `
              <div class="verse-tafsir">
                <div class="tafsir-title">التفسير</div>
                <p>${ayahTafsir}</p>
              </div>
            ` : ''}
          </div>
        `;
      });

      elements.quranContent.innerHTML = html;
      applyFontSize();
    }

    // Search surahs
    function searchSurahs() {
      const searchTerm = elements.searchInput.value.toLowerCase();
      const surahItems = document.querySelectorAll('.surah-item');

      surahItems.forEach(item => {
        const surahNameEn = item.querySelector('.surah-name-en').textContent.toLowerCase();
        const surahNameAr = item.querySelector('.surah-name-ar').textContent.toLowerCase();

        if (surahNameEn.includes(searchTerm) || surahNameAr.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Play a specific ayah
    async function playAyah(surahNumber, ayahNumber) {
      try {
        currentSurah = parseInt(surahNumber);
        currentAyah = parseInt(ayahNumber);

        const audioUrl = `${API_BASE}/ayah/${settings.reciter}:${surahNumber}:${ayahNumber}`;

        // Load and play audio
        audioPlayer.src = audioUrl;
        audioPlayer.play().catch(error => {
          console.error('Error playing audio:', error);
          alert('حدث خطأ أثناء تشغيل الآية. يرجى المحاولة لاحقاً.');
        });

        // Highlight current ayah
        document.querySelectorAll('.verse-container').forEach(verse => {
          verse.style.boxShadow = 'none';
        });

        const currentVerse = document.querySelector(`.verse-container[data-number="${ayahNumber}"]`);
        if (currentVerse) {
          currentVerse.style.boxShadow = '0 0 0 2px var(--primary-color)';
          currentVerse.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

      } catch (error) {
        console.error('Error playing ayah:', error);
        alert('حدث خطأ أثناء تشغيل الآية. يرجى المحاولة لاحقاً.');
      }
    }

    // Toggle play/pause
    function togglePlay() {
      if (audioPlayer.paused) {
        if (audioPlayer.src) {
          audioPlayer.play().catch(error => {
            console.error('Error playing audio:', error);
            alert('حدث خطأ أثناء تشغيل الآية. يرجى المحاولة لاحقاً.');
          });
        } else {
          playAyah(currentSurah, 1);
        }
      } else {
        audioPlayer.pause();
      }
    }

    // Play next ayah
    function playNextAyah() {
      if (!settings.autoPlay) return;

      const currentSurahData = surahsData.find(s => s.number === currentSurah);
      if (currentAyah < currentSurahData.numberOfAyahs) {
        playAyah(currentSurah, currentAyah + 1);
      } else if (currentSurah < 114) {
        playAyah(currentSurah + 1, 1);
      }
    }

    // Update audio progress bar
    function updateProgress() {
      if (audioPlayer.duration) {
        const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        elements.progressFill.style.width = `${progressPercent}%`;

        const currentTime = formatTime(audioPlayer.currentTime);
        const duration = formatTime(audioPlayer.duration);
        elements.timeDisplay.textContent = `${currentTime} / ${duration}`;
      }
    }

    // Format time (seconds to MM:SS)
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Seek audio when clicking on progress bar
    function seekAudio(e) {
      if (audioPlayer.duration) {
        const percent = e.offsetX / elements.progressBar.offsetWidth;
        audioPlayer.currentTime = percent * audioPlayer.duration;
      }
    }

    // Copy ayah text to clipboard
    function copyAyah(surahNumber, ayahNumber) {
      const verseContainer = document.querySelector(`.verse-container[data-number="${ayahNumber}"]`);
      if (verseContainer) {
        const arabicText = verseContainer.querySelector('.verse-arabic').textContent;
        const translationText = verseContainer.querySelector('.verse-translation')?.textContent || '';

        const textToCopy = `${arabicText}\n${translationText}`;

        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            alert('تم نسخ الآية بنجاح');
          })
          .catch(err => {
            console.error('Failed to copy text: ', err);
            alert('حدث خطأ أثناء نسخ الآية');
          });
      }
    }

    // Copy current surah to clipboard
    function copyCurrentSurah() {
      if (!currentSurahData) return;

      let textToCopy = `سورة ${currentSurahData.englishName} - ${currentSurahData.name}\n\n`;

      document.querySelectorAll('.verse-container').forEach(verse => {
        const arabicText = verse.querySelector('.verse-arabic').textContent;
        const translationText = verse.querySelector('.verse-translation')?.textContent || '';

        textToCopy += `${arabicText}\n${translationText}\n\n`;
      });

      navigator.clipboard.writeText(textToCopy)
        .then(() => {
          alert('تم نسخ السورة بنجاح');
        })
        .catch(err => {
          console.error('Failed to copy text: ', err);
          alert('حدث خطأ أثناء نسخ السورة');
        });
    }

    // Download current surah
    function downloadCurrentSurah() {
      if (!currentSurahData) return;

      let textContent = `سورة ${currentSurahData.englishName} - ${currentSurahData.name}\n\n`;

      document.querySelectorAll('.verse-container').forEach(verse => {
        const arabicText = verse.querySelector('.verse-arabic').textContent;
        const translationText = verse.querySelector('.verse-translation')?.textContent || '';

        textContent += `${arabicText}\n${translationText}\n\n`;
      });

      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `سورة ${currentSurahData.englishName}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Toggle sidebar on mobile
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('active');
      document.querySelector('.overlay').classList.toggle('active');
    }

    // Toggle settings panel
    function toggleSettingsPanel() {
      document.querySelector('.settings-panel').classList.toggle('active');
      document.querySelector('.overlay').classList.toggle('active');
    }

    // Apply saved settings
    function applySettings() {
      // Dark mode
      if (settings.darkMode) {
        document.body.classList.add('dark-mode');
        elements.darkModeToggle.checked = true;
      }

      // Font size
      elements.fontSizeSlider.value = settings.fontSize;
      applyFontSize();

      // Translation
      elements.showTranslationToggle.checked = settings.showTranslation;

      // Tafsir
      elements.showTafsirToggle.checked = settings.showTafsir;

      // Translation source
      elements.translationSelect.value = settings.translation;

      // Tafsir source
      elements.tafsirSelect.value = settings.tafsir;

      // Reciter
      elements.reciterSelect.value = settings.reciter;

      // Auto play
      elements.autoPlayToggle.checked = settings.autoPlay;
    }

    // Apply font size to verses
    function applyFontSize() {
      const sizeMap = {
        1: '18px',
        2: '20px',
        3: '22px',
        4: '24px',
        5: '26px',
        6: '28px',
        7: '30px',
        8: '32px',
        9: '34px',
        10: '36px'
      };

      const arabicElements = document.querySelectorAll('.verse-arabic');
      arabicElements.forEach(el => {
        el.style.fontSize = sizeMap[settings.fontSize];
      });
    }

    // Toggle dark mode
    function toggleDarkMode() {
      settings.darkMode = elements.darkModeToggle.checked;
      document.body.classList.toggle('dark-mode', settings.darkMode);
      localStorage.setItem('darkMode', settings.darkMode);
    }

    // Update font size
    function updateFontSize() {
      settings.fontSize = elements.fontSizeSlider.value;
      localStorage.setItem('fontSize', settings.fontSize);
      applyFontSize();
    }

    // Toggle translation visibility
    function toggleTranslation() {
      settings.showTranslation = elements.showTranslationToggle.checked;
      localStorage.setItem('showTranslation', settings.showTranslation);

      const translations = document.querySelectorAll('.verse-translation');
      translations.forEach(el => {
        el.style.display = settings.showTranslation ? 'block' : 'none';
      });
    }

    // Toggle tafsir visibility
    function toggleTafsir() {
      settings.showTafsir = elements.showTafsirToggle.checked;
      localStorage.setItem('showTafsir', settings.showTafsir);

      const tafsirs = document.querySelectorAll('.verse-tafsir');
      tafsirs.forEach(el => {
        el.style.display = settings.showTafsir ? 'block' : 'none';
      });
    }

    // Update translation source
    function updateTranslation() {
      settings.translation = elements.translationSelect.value;
      localStorage.setItem('translation', settings.translation);
      loadSurah(currentSurah);
    }

    // Update tafsir source
    function updateTafsir() {
      settings.tafsir = elements.tafsirSelect.value;
      localStorage.setItem('tafsir', settings.tafsir);
      loadSurah(currentSurah);
    }

    // Update reciter
    function updateReciter() {
      settings.reciter = elements.reciterSelect.value;
      localStorage.setItem('reciter', settings.reciter);

      if (!audioPlayer.paused) {
        playAyah(currentSurah, currentAyah);
      }
    }

    // Update auto play setting
    function updateAutoPlay() {
      settings.autoPlay = elements.autoPlayToggle.checked;
      localStorage.setItem('autoPlay', settings.autoPlay);
    }

    // Make functions available globally
    window.copyAyah = copyAyah;
    window.playAyah = playAyah;
  </script>
</body>

</html>